<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>HTTP缓存</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.992cb7aa.css" as="style"><link rel="preload" href="/assets/js/app.d3071f17.js" as="script"><link rel="preload" href="/assets/js/2.4f517b48.js" as="script"><link rel="preload" href="/assets/js/7.9916a0b1.js" as="script"><link rel="prefetch" href="/assets/js/3.957cc2dd.js"><link rel="prefetch" href="/assets/js/4.09fd2c39.js"><link rel="prefetch" href="/assets/js/5.b99a1609.js"><link rel="prefetch" href="/assets/js/6.ffe6f60a.js"><link rel="prefetch" href="/assets/js/8.8a393a95.js">
    <link rel="stylesheet" href="/assets/css/0.styles.992cb7aa.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-navbar"><!----> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>HTTP缓存</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/#缓存的概念" class="sidebar-link">缓存的概念</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/#缓存的作用和优势" class="sidebar-link">缓存的作用和优势</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/#缓存策略" class="sidebar-link">缓存策略</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/#cache-control" class="sidebar-link">Cache-Control</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/#etag" class="sidebar-link">Etag</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/#if-none-match" class="sidebar-link">If-None-Match</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/#last-modified" class="sidebar-link">Last-Modified</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/#if-modified-since" class="sidebar-link">If-Modified-Since</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/#expires" class="sidebar-link">Expires</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/#流程图" class="sidebar-link">流程图</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/#缓存和浏览器操作" class="sidebar-link">缓存和浏览器操作</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="http缓存"><a href="#http缓存" class="header-anchor">#</a> <strong>HTTP</strong>缓存</h1> <h2 id="缓存的概念"><a href="#缓存的概念" class="header-anchor">#</a> 缓存的概念</h2> <p>HTTP缓存是用于临时存储web文档以减少服务器延迟的一种信息技术。
当用户首次访问网页时，如果请求满足某些条件，资源文件会被缓存在内存中，同时也会在本地磁盘中保留一份副本。
当用户刷新页面时，如果缓存的资源没有过期， 就可以直接从内存中读取数据并加载。当用户关闭页面后，当前页面缓存在内存中的资源就会被清空。
当用户在一次访问页面是，如果资源文件的缓存没有过期，就可以从本地磁盘加载数据并再次缓存到内存中。</p> <h2 id="缓存的作用和优势"><a href="#缓存的作用和优势" class="header-anchor">#</a> 缓存的作用和优势</h2> <p>在前端开发中，性能问题一直都是最值得重视的一点，判断一个网站的性能如何，最直观的方法就是看网页的打开速度。其中，提高网页打开速度的一个方式就是使用缓存。
合理地利用缓存，能够最大限度地读取和利用本地已有静态资源，减少数据传输，减少延迟，从而加快网页应用的呈现。
并且由于缓存文件可以重复利用，因此可以减少带宽，降低网络负荷。在用户较少的情况下作用并不是特别明显，但是在高并发的场景下，使用缓存对于服务器的负担非常有帮助。</p> <h2 id="缓存策略"><a href="#缓存策略" class="header-anchor">#</a> 缓存策略</h2> <p>按照缓存策略，HTTP缓存可以分为强缓存和协商缓存两大类。如下图所示：</p> <p><img src="https://i.loli.net/2021/05/06/aiHjZsCJqfKrSyn.png" alt="微信截图_20210506001452.png"></p> <h2 id="cache-control"><a href="#cache-control" class="header-anchor">#</a> Cache-Control</h2> <p><code>public</code></p> <p>表明响应可以被任何对象（包括：发送请求的客户端，代理服务器，等等）缓存，即使是通常不可缓存的内容。（例如：1.该响应没有max-age指令或Expires消息头；2. 该响应对应的请求方法是 POST 。）</p> <p><code>private</code></p> <p>表明响应只能被单个用户缓存，不能作为共享缓存（即代理服务器不能缓存它）。私有缓存可以缓存响应内容，比如：对应用户的本地浏览器。</p> <p><code>no-cache</code></p> <p>在发布缓存副本之前，强制要求缓存把请求提交给原始服务器进行验证(协商缓存验证)。</p> <p><code>no-store</code></p> <p>缓存不应存储有关客户端请求或服务器响应的任何内容，即不使用任何缓存</p> <p><code>max-age=&lt;seconds&gt;</code></p> <p>设置缓存存储的最大周期，超过这个时间缓存被认为过期(单位秒)。与Expires相反，时间是相对于请求的时间。<br>
缓存未过期, 读取本地缓存，不会向服务器发送请求。</p> <p><img src="https://i.loli.net/2021/05/06/xIN42MXugnHF8bj.png" alt="微信截图_20210506112056.png"></p> <p>缓存已过期，走协商缓存，向服务器发送请求验证资源是否变更。无变更-》304，有变更-》200。</p> <p><img src="https://i.loli.net/2021/05/06/LtTIbClHNhWRE6m.png" alt="image.png"></p> <p><code>s-maxage=&lt;seconds&gt;</code></p> <p>覆盖max-age或者Expires头，但是仅适用于共享缓存(比如各个代理)，私有缓存会忽略它。</p> <p><code>must-revalidate</code></p> <p>一旦资源过期（比如已经超过max-age），在成功向原始服务器验证之前，缓存不能用该资源响应后续请求。</p> <p><code>proxy-revalidate</code></p> <p>与<code>must-revalidate</code>作用相同，但它仅适用于共享缓存（例如代理），并被私有缓存忽略。</p> <h2 id="etag"><a href="#etag" class="header-anchor">#</a> Etag</h2> <p><code>ETag</code> HTTP响应头是资源的特定版本的标识符。这可以让缓存更高效，并节省带宽，因为如果内容没有改变，Web服务器不需要发送完整的响应。而如果内容发生了变化，使用ETag有助于防止资源的同时更新相互覆盖（“空中碰撞”）。</p> <p>如果给定URL中的资源更改，则一定要生成新的Etag值。 因此Etags类似于指纹，也可能被某些服务器用于跟踪。 比较etags能快速确定此资源是否变化，但也可能被跟踪服务器永久存留</p> <p><code>W/ 可选</code></p> <p>'W/'(大小写敏感) 表示使用弱验证器。 弱验证器很容易生成，但不利于比较。 强验证器是比较的理想选择，但很难有效地生成。 相同资源的两个弱Etag值可能语义等同，但不是每个字节都相同。</p> <p><code>&lt;etag_value&gt;</code></p> <p>实体标签唯一地表示所请求的资源。 它们是位于双引号之间的ASCII字符串（如“675af34563dc-tr34”）。 没有明确指定生成ETag值的方法。
通常，使用内容的散列，最后修改时间戳的哈希值，或简单地使用版本号。 例如，MDN使用wiki内容的十六进制数字的哈希值。
<img src="https://i.loli.net/2021/05/06/9J3prNIUL58Tunb.png" alt="微信截图_20210506102430.png"></p> <h2 id="if-none-match"><a href="#if-none-match" class="header-anchor">#</a> If-None-Match</h2> <p><code>If-None-Match</code> 是一个条件式请求首部。对于 <code>GET</code> 和 <code>HEAD</code> 请求方法来说，当且仅当服务器上没有任何资源的 <code>ETag</code> 属性值与这个首部中列出的相匹配的时候，服务器端会才返回所请求的资源，响应码为  200  。
对于其他方法来说，当且仅当最终确认没有已存在的资源的  <code>ETag</code> 属性值与这个首部中所列出的相匹配的时候，才会对请求进行相应的处理。</p> <p><img src="https://i.loli.net/2021/05/06/QwMXPRCrl3bfU4F.png" alt="微信截图_20210506102701.png"></p> <h2 id="last-modified"><a href="#last-modified" class="header-anchor">#</a> Last-Modified</h2> <p><code>Last-Modified</code>  是一个响应首部，其中包含源头服务器认定的资源做出修改的日期及时间。 它通常被用作一个验证器来判断接收到的或者存储的资源是否彼此一致。
由于精确度比  ETag 要低，所以这是一个备用机制。包含有  If-Modified-Since 或 If-Unmodified-Since 首部的条件请求会使用这个字段。</p> <p><img src="https://i.loli.net/2021/05/06/wGUClImTxy7q26D.png" alt="img.png"></p> <h2 id="if-modified-since"><a href="#if-modified-since" class="header-anchor">#</a> If-Modified-Since</h2> <p><code>If-Modified-Since</code> 是一个条件式请求首部，服务器只在所请求的资源在给定的日期时间之后对内容进行过修改的情况下才会将资源返回，状态码为 200 。
如果请求的资源从那时起未经修改，那么返回一个不带有消息主体的  304  响应，而在 <code>Last-Modified</code> 首部中会带有上次修改时间。
不同于 <code>If-Unmodified-Since</code>, If-Modified-Since 只可以用在 GET 或 HEAD 请求中。</p> <p>当与 <code>If-None-Match</code> 一同出现时，它（<code>If-Modified-Since</code>）会被忽略掉，除非服务器不支持 <code>If-None-Match</code>。</p> <p><img src="https://i.loli.net/2021/05/06/tUFu6HdaresT5MI.png" alt="微信截图_20210506100424.png"></p> <h2 id="expires"><a href="#expires" class="header-anchor">#</a> Expires</h2> <p><code>Expires</code> 响应头包含日期/时间， 即在此时候之后，响应过期。</p> <p>无效的日期，比如 0, 代表着过去的日期，即该资源已经过期。</p> <p>如果在<code>Cache-Control</code>响应头设置了 <code>max-age</code> 或者 <code>s-max-age</code> 指令，那么 <code>Expires</code> 头会被忽略。</p> <p><code>Expires</code>有一个非常大的缺陷，它使用一个固定的时间，受限于本地时间，如果修改了本地时间，可能会造成缓存失效。
所以要求服务器与客户端的时钟保持严格的同步，并且这一天到来后，服务器还得重新设定新的时间。</p> <h2 id="流程图"><a href="#流程图" class="header-anchor">#</a> 流程图</h2> <p><img src="https://i.loli.net/2021/05/05/hQ9yWkPveFMomKH.png" alt="微信截图_20210505234825.png"></p> <p>如图所示， 其中强制缓存优先级最高，并且缓存有效期内浏览器不会因为资源的改动而发送请求，因此强制缓存的使用适用于比较大而且不会轻易修改的资源文件。</p> <p>协商缓存灵活性高，适用于数据缓存，采用Etag标识比对文件内容是否发生变化的灵活都最高，也最为可靠。
对于数据的缓存，可以重点考虑将数据缓存在内存中，因为内存加载速度最快，并且数据的体积比较小。</p> <h2 id="缓存和浏览器操作"><a href="#缓存和浏览器操作" class="header-anchor">#</a> 缓存和浏览器操作</h2> <p>常见的浏览器操作对应的缓存有如下行为：</p> <ul><li><p>当用户使用 <kbd>Ctrl</kbd> + <kbd>F5</kbd> 强制刷新网页时，浏览器会直接从服务器加载网页信息，跳过强缓存和协商缓存。</p></li> <li><p>当用户使用 <kbd>F5</kbd> 刷新网页时，浏览器的加载过程会跳过强缓存，但是仍然会进行协商缓存。</p></li></ul> <p>如下表格所示，典型的刷新操作对应的缓存行为：</p> <table><thead><tr><th style="text-align:left;">浏览器操作</th> <th style="text-align:left;">Expires/Cache-Control</th> <th style="text-align:left;">Last-Modified/Etag</th></tr></thead> <tbody><tr><td style="text-align:left;">地址栏中按回车键</td> <td style="text-align:left;">有效</td> <td style="text-align:left;">有效</td></tr> <tr><td style="text-align:left;">页面跳转</td> <td style="text-align:left;">有效</td> <td style="text-align:left;">有效</td></tr> <tr><td style="text-align:left;">新窗口打开</td> <td style="text-align:left;">有效</td> <td style="text-align:left;">有效</td></tr> <tr><td style="text-align:left;">浏览器前进后退</td> <td style="text-align:left;">有效</td> <td style="text-align:left;">有效</td></tr> <tr><td style="text-align:left;">浏览器刷新</td> <td style="text-align:left;">无效</td> <td style="text-align:left;">有效</td></tr> <tr><td style="text-align:left;">强制刷新</td> <td style="text-align:left;">无效</td> <td style="text-align:left;">无效</td></tr></tbody></table></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d3071f17.js" defer></script><script src="/assets/js/2.4f517b48.js" defer></script><script src="/assets/js/7.9916a0b1.js" defer></script>
  </body>
</html>
